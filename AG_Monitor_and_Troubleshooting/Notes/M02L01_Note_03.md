### **What is the Lease Time-Out Mechanism?**
The **lease mechanism** is a critical health check used in **Always On Availability Groups** and **Failover Cluster Instances** to prevent **split-brain scenarios** and ensure synchronization between **SQL Server** and the **Windows Server Failover Cluster (WSFC)**.

- It acts as a **Looks-Alive validation** between the **SQL Server resource DLL** (running in the cluster resource host) and a **dedicated lease worker thread** inside SQL Server.
- Both sides share a small memory region and exchange **lease renewal signals** at regular intervals.
- If either side fails to renew the lease within the configured **LeaseTimeout** period, the lease expires, and the replica transitions to the **resolving state**, triggering a failover if necessary.

---

### **Default and Behavior**
- **Default LeaseTimeout**: **20 seconds**.
- The lease worker updates a **time-to-live (TTL)** value each time it receives a renewal signal. If TTL expires without a signal, the lease is considered broken.
- The mechanism ensures that if the cluster cannot communicate with SQL Server (due to OS hang, high CPU, memory dump, or WSFC quorum loss), the AG resource is taken offline to maintain cluster consistency.

---

### **Why is it Important?**
- Prevents **split-brain** (two nodes thinking they are primary).
- Provides a **fast failover trigger** when SQL Server becomes unresponsive.
- Works independently of other checks like **LooksAlive** and **IsAlive**, giving AG more control over failover conditions.

---

### **Common Causes of Lease Timeout**
- **High CPU utilization** (close to 100%).
- **Out-of-memory conditions** or paging.
- **SQL Server generating a memory dump** (pauses execution).
- **Disk I/O latency** or VM throttling.
- **WSFC issues** like quorum loss.

what does it mean of **Disk I/O latency** or VM throttling?

### **Disk I/O Latency**
- This refers to delays in reading from or writing to the storage subsystem (disks, SAN, SSD, etc.).
- If the disk is slow or overloaded, SQL Server threads can get stuck waiting for I/O operations to complete.
- During this time, the lease renewal thread might not get CPU time to update the lease, causing the cluster to think SQL Server is unresponsive.
- **Common causes:** slow storage, high concurrent I/O, misconfigured storage paths, or network storage congestion.

### **VM Throttling**
- Happens in virtualized environments (Hyper-V, VMware, etc.) when the hypervisor limits CPU or I/O resources for a virtual machine.
- If the VM hosting SQL Server is throttled (due to resource limits or contention with other VMs), SQL Server processes—including the lease worker—may not run on time.
- This can lead to missed lease renewals and unnecessary failovers.

**Why it matters:** Both conditions can make SQL Server appear “hung” to the cluster even though it’s technically running, because the lease heartbeat isn’t updated in time.

---

### **Configuration and Best Practices**
- **Do not lower LeaseTimeout** below default; it can cause unnecessary failovers.
- Adjust only after careful testing, considering **network latency** and **resource pressure**.
- Ensure **½ * LeaseTimeout < SameSubnetThreshold * SameSubnetDelay** to maintain proper failover sequencing.
